var W=i=>{throw TypeError(i)};var N=(i,n,e)=>n.has(i)||W("Cannot "+e);var s=(i,n,e)=>(N(i,n,"read from private field"),e?e.call(i):n.get(i)),g=(i,n,e)=>n.has(i)?W("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(i):n.set(i,e),l=(i,n,e,t)=>(N(i,n,"write to private field"),t?t.call(i,e):n.set(i,e),e),O=(i,n,e)=>(N(i,n,"access private method"),e);var V=(i,n,e,t)=>({set _(r){l(i,n,r,e)},get _(){return s(i,n,t)}});import{S as K,V as J,M as f,E as tt,a as U,Q as k,b as et}from"./three-CHtozH2C.js";var y,X,Y,Z,B;class it{constructor(){g(this,y);this.EARTH=4007501668e-2,this.HALF_EARTH=2003750834e-2}project(n,e){return[O(this,y,X).call(this,n),O(this,y,Y).call(this,e)]}unproject(n){return[O(this,y,Z).call(this,n[0]),O(this,y,B).call(this,n[1])]}getID(){return"epsg:3857"}}y=new WeakSet,X=function(n){return n/180*this.HALF_EARTH},Y=function(n){var e=Math.log(Math.tan((90+n)*Math.PI/360))/(Math.PI/180);return e*this.HALF_EARTH/180},Z=function(n){return n/this.HALF_EARTH*180},B=function(n){var e=n/this.HALF_EARTH*180;return e=180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2),e};class G{constructor(){this.eventHandlers={}}on(n,e){this.eventHandlers[n]=e}emit(n,...e){var t;(t=this.eventHandlers[n])==null||t.call(this,...e)}}var D,q,C,R,L,P,w,_,I,M,E,j,Q,S,$;class nt extends G{constructor(e,t,r={},u=null){super();g(this,E);g(this,D);g(this,q);g(this,C);g(this,R);g(this,L);g(this,P);g(this,w);g(this,_);g(this,I);g(this,M);this.scene=e,this.camera=t,l(this,D,new it),l(this,C,null),l(this,R,0),l(this,L,100),l(this,P,null),this.setGpsOptions(r),l(this,w,null),l(this,_,0),l(this,I,0),l(this,M,u)}setProjection(e){l(this,D,e)}setGpsOptions(e={}){e.gpsMinDistance!==void 0&&l(this,R,e.gpsMinDistance),e.gpsMinAccuracy!==void 0&&l(this,L,e.gpsMinAccuracy)}async startGps(){if(s(this,M)){const e=await(await s(this,M).sendData("/gps/start",{gpsMinDistance:s(this,R),gpsMinAccuracy:s(this,L)})).json();l(this,I,e.session)}return s(this,P)===null?(l(this,P,navigator.geolocation.watchPosition(e=>{O(this,E,S).call(this,e)},e=>{this.emit("gpserror",e)},{enableHighAccuracy:!0})),!0):!1}stopGps(){return s(this,P)!==null?(navigator.geolocation.clearWatch(s(this,P)),l(this,P,null),!0):!1}fakeGps(e,t,r=null,u=0){r!==null&&this.setElevation(r),O(this,E,S).call(this,{coords:{longitude:e,latitude:t,accuracy:u}})}lonLatToWorldCoords(e,t){const r=s(this,D).project(e,t);if(s(this,w))r[0]-=s(this,w)[0],r[1]-=s(this,w)[1];else throw"No initial position determined";return[r[0],-r[1]]}add(e,t,r,u,p={}){var o;e.properties=p,O(this,E,j).call(this,e,t,r,u),this.scene.add(e),(o=s(this,M))==null||o.sendData("/object/new",{position:e.position,x:e.position.x,z:e.position.z,session:s(this,I),properties:p})}setElevation(e){this.camera.position.y=e}}D=new WeakMap,q=new WeakMap,C=new WeakMap,R=new WeakMap,L=new WeakMap,P=new WeakMap,w=new WeakMap,_=new WeakMap,I=new WeakMap,M=new WeakMap,E=new WeakSet,j=function(e,t,r,u){const p=this.lonLatToWorldCoords(t,r);u!==void 0&&(e.position.y=u),[e.position.x,e.position.z]=p},Q=function(e,t){l(this,w,s(this,D).project(e,t))},S=function(e){var r,u,p;let t=Number.MAX_VALUE;V(this,_)._++,(r=s(this,M))==null||r.sendData("/gps/new",{gpsCount:s(this,_),lat:e.coords.latitude,lon:e.coords.longitude,acc:e.coords.accuracy,session:s(this,I)}),e.coords.accuracy<=s(this,L)&&(s(this,C)===null?l(this,C,{latitude:e.coords.latitude,longitude:e.coords.longitude}):t=O(this,E,$).call(this,s(this,C),e.coords),t>=s(this,R)&&(s(this,C).longitude=e.coords.longitude,s(this,C).latitude=e.coords.latitude,s(this,w)||(O(this,E,Q).call(this,e.coords.longitude,e.coords.latitude),(u=s(this,M))==null||u.sendData("/worldorigin/new",{gpsCount:s(this,_),lat:e.coords.latitude,lon:e.coords.longitude,session:s(this,I),initialPosition:s(this,w)})),O(this,E,j).call(this,this.camera,e.coords.longitude,e.coords.latitude),(p=s(this,M))==null||p.sendData("/gps/accepted",{gpsCount:s(this,_),cameraX:this.camera.position.x,cameraZ:this.camera.position.z,session:s(this,I),distMoved:t}),this.emit("gpsupdate",{position:e,distMoved:t})))},$=function(e,t){const r=f.degToRad(t.longitude-e.longitude),u=f.degToRad(t.latitude-e.latitude),p=Math.sin(u/2)*Math.sin(u/2)+Math.cos(f.degToRad(e.latitude))*Math.cos(f.degToRad(t.latitude))*(Math.sin(r/2)*Math.sin(r/2));return 2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p))*6371e3};var m;class ot extends G{constructor(e={video:{facingMode:"environment"}},t){super();g(this,m);this.sceneWebcam=new K,t?l(this,m,document.querySelector(t)):(l(this,m,document.createElement("video")),s(this,m).setAttribute("autoplay",!0),s(this,m).setAttribute("playsinline",!0),s(this,m).style.display="none",document.body.appendChild(s(this,m))),this.texture=new J(s(this,m)),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(e).then(r=>{s(this,m).addEventListener("loadedmetadata",()=>{s(this,m).setAttribute("width",s(this,m).videoWidth),s(this,m).setAttribute("height",s(this,m).videoHeight),s(this,m).play(),this.emit("webcamstarted",{texture:this.texture})}),s(this,m).srcObject=r}).catch(r=>{this.emit("webcamerror",{code:r.name,message:r.message})}):this.emit("webcamerror",{code:"LOCAR_NO_MEDIA_DEVICES_API",message:"Media devices API not supported"})}dispose(){this.texture.dispose()}}m=new WeakMap;const x=navigator.userAgent.match(/iPhone|iPad|iPod/i)||/Macintosh/i.test(navigator.userAgent)&&navigator.maxTouchPoints!=null&&navigator.maxTouchPoints>1,st=new et(0,0,1),z=new U,at=new k,rt=new k(-Math.sqrt(.5),0,0,Math.sqrt(.5));class dt extends tt{constructor(n,e={}){super(),this.eventEmitter=new G;const t=this;this.object=n,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation=null,this.screenOrientation=0,this.alphaOffset=0,this.orientationOffset=0,this.initialOffset=null,this.lastCompassY=void 0,this.lastOrientation=null,this.TWO_PI=2*Math.PI,this.HALF_PI=.5*Math.PI,this.orientationChangeEventName="ondeviceorientationabsolute"in window?"deviceorientationabsolute":"deviceorientation",console.log("Device Orientation Event Name:",this.orientationChangeEventName),this.smoothingFactor=e.smoothingFactor||1,this.enablePermissionDialog=e.enablePermissionDialog??!0;const r=function({alpha:o,beta:a,gamma:c,webkitCompassHeading:h}){if(x){const d=360-h;t.alphaOffset=f.degToRad(d-o),t.deviceOrientation={alpha:o,beta:a,gamma:c,webkitCompassHeading:h}}else o<0&&(o+=360),t.deviceOrientation={alpha:o,beta:a,gamma:c};window.dispatchEvent(new CustomEvent("camera-rotation-change",{detail:{cameraRotation:n.rotation}}))},u=function(){t.screenOrientation=window.orientation||0,x&&(t.screenOrientation===90?t.orientationOffset=-t.HALF_PI:t.screenOrientation===-90?t.orientationOffset=t.HALF_PI:t.orientationOffset=0)},p=function(o,a,c,h,d){z.set(c,a,-h,"YXZ"),o.setFromEuler(z),o.multiply(rt),o.multiply(at.setFromAxisAngle(st,-d))};this.connect=function(){u(),window.addEventListener("orientationchange",u),window.addEventListener(t.orientationChangeEventName,r),t.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",u),window.removeEventListener(t.orientationChangeEventName,r),t.enabled=!1,t.initialOffset=!1,t.deviceOrientation=null},this.requestOrientationPermissions=function(){window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(o=>{o==="granted"?this.eventEmitter.emit("deviceorientationgranted",{target:this}):this.eventEmitter.emit("deviceorientationerror",{code:"LOCAR_DEVICE_ORIENTATION_PERMISSION_DENIED",message:"Permission for device orientation denied - AR will not work correctly"})}).catch(function(o){this.eventEmitter.emit("deviceorientationerror",{code:"LOCAR_DEVICE_ORIENTATION_PERMISSION_FAILED",message:"Permission request for device orientation failed - AR will not work correctly"})}):this.eventEmitter.emit("deviceorientationerror",{code:"LOCAR_DEVICE_ORIENTATION_INTERNAL_ERROR",message:"Internal error: no requestPermission() found although requestOrientationPermissions() was called - please raise an issue on GitHub"})},this.update=function({theta:o=0}={theta:0}){if(t.enabled===!1)return;const a=t.deviceOrientation;if(a){let c=a.alpha?f.degToRad(a.alpha)+t.alphaOffset:0,h=a.beta?f.degToRad(a.beta):0,d=a.gamma?f.degToRad(a.gamma):0;const T=t.screenOrientation?f.degToRad(t.screenOrientation):0;if(t.smoothingFactor<1){if(t.lastOrientation){const v=t.smoothingFactor;c=t._getSmoothedAngle(c,t.lastOrientation.alpha,v),h=t._getSmoothedAngle(h+Math.PI,t.lastOrientation.beta,v),d=t._getSmoothedAngle(d+t.HALF_PI,t.lastOrientation.gamma,v,Math.PI)}else h+=Math.PI,d+=t.HALF_PI;t.lastOrientation={alpha:c,beta:h,gamma:d}}if(x){const v=new k;p(v,c,t.smoothingFactor<1?h-Math.PI:h,t.smoothingFactor<1?d-Math.PI/2:d,T);const A=new U().setFromQuaternion(v,"YXZ");let H=f.degToRad(360-a.webkitCompassHeading);t.smoothingFactor<1&&t.lastCompassY!==void 0&&(H=t._getSmoothedAngle(H,t.lastCompassY,t.smoothingFactor)),t.lastCompassY=H,A.y=H+(t.orientationOffset||0),v.setFromEuler(A),t.object.quaternion.copy(v)}else p(t.object.quaternion,x?c+t.alphaOffset:c,t.smoothingFactor<1?h-Math.PI:h,t.smoothingFactor<1?d-Math.PI/2:d,T)}},this.getCorrectedHeading=function(){const{deviceOrientation:o}=t;if(!o)return 0;let a=0;return x?(a=360-o.webkitCompassHeading,t.orientationOffset&&(a+=t.orientationOffset*(180/Math.PI),a=(a+360)%360)):(o.absolute===!0||t.orientationChangeEventName,a=o.alpha?o.alpha:0,a=(360-a)%360,a<0&&(a+=360)),a},this._orderAngle=function(o,a,c=t.TWO_PI){return a>o&&Math.abs(a-o)<c/2||o>a&&Math.abs(a-o)>c/2?{left:o,right:a}:{left:a,right:o}},this._getSmoothedAngle=function(o,a,c,h=t.TWO_PI){const d=t._orderAngle(o,a,h),T=d.left,v=d.right;d.left=0,d.right-=T,d.right<0&&(d.right+=h);let A=v==a?(1-c)*d.right+c*d.left:c*d.right+(1-c)*d.left;return A+=T,A>=h&&(A-=h),A},this.updateAlphaOffset=function(){t.initialOffset=!1},this.dispose=function(){t.disconnect()},this.getAlpha=function(){const{deviceOrientation:o}=t;return o&&o.alpha?f.degToRad(o.alpha)+t.alphaOffset:0},this.getBeta=function(){const{deviceOrientation:o}=t;return o&&o.beta?f.degToRad(o.beta):0},this.getGamma=function(){const{deviceOrientation:o}=t;return o&&o.gamma?f.degToRad(o.gamma):0},this.obtainPermissionGesture=function(){const o=document.createElement("div"),a=document.createElement("div"),c=document.createElement("div"),h=document.createElement("div");document.body.appendChild(o);const d={display:"flex",position:"fixed",top:0,left:0,width:"100%",height:"100%",zIndex:1,backgroundColor:"rgba(0,0,0,0.6)",justifyContent:"center",alignItems:"center"},T={backgroundColor:"white",padding:"6px",borderRadius:"3px",width:"36rem",height:"24rem"},v={width:"100%",height:"70%",display:"flex",justifyContent:"center",alignItems:"center"},A={display:"inline-flex",width:"100%",height:"30%",justifyContent:"center",alignItems:"center"};for(let b in d)o.style[b]=d[b];for(let b in T)a.style[b]=T[b];for(let b in v)c.style[b]=v[b];for(let b in A)h.style[b]=A[b];o.appendChild(a),a.appendChild(c),a.appendChild(h),c.innerHTML='<div style="font-size: 24pt; margin: 1rem;">This immersive website requires access to your device motion sensors.</div>';const H=()=>{this.requestOrientationPermissions(),o.style.display="none"},F=document.createElement("button");F.addEventListener("click",H),F.style.width="50%",F.style.height="80%",F.style.fontSize="20pt",F.appendChild(document.createTextNode("OK")),h.appendChild(F),document.body.appendChild(o)}}on(n,e){this.eventEmitter.on(n,e)}init(){window.DeviceOrientationEvent===void 0?this.eventEmitter.emit("deviceorientationerror",{code:"LOCAR_DEVICE_ORIENTATION_NOT_SUPPORTED",message:"Device orientation API not supported"}):window.isSecureContext===!1?this.eventEmitter.emit("deviceorientationerror",{code:"LOCAR_DEVICE_ORIENTATION_NO_HTTPS",message:"DeviceOrientationEvent is only available in secure contexts (https)"}):typeof window.DeviceOrientationEvent.requestPermission=="function"&&this.enablePermissionDialog?this.obtainPermissionGesture():this.eventEmitter.emit("deviceorientationgranted",{target:this})}}AFRAME.registerComponent("locar-webcam",{schema:{idealWidth:{type:"number",default:1024},idealHeight:{type:"number",default:768},videoElement:{type:"string",default:""}},init:function(){const i=new ot({video:{facingMode:"environment",width:{ideal:this.data.idealWidth},height:{ideal:this.data.idealHeight}}},this.data.videoElement||null);i.on("webcamstarted",n=>{this.el.object3D.background=n.texture}),i.on("webcamerror",n=>{this.el.emit("webcamerror",n)})}});AFRAME.registerComponent("locar-camera",{schema:{simulateLatitude:{type:"number",default:0},simulateLongitude:{type:"number",default:0},simulateAltitude:{type:"number",default:-Number.MAX_VALUE},positionMinAccuracy:{type:"number",default:100},smoothingFactor:{type:"number",default:1},enablePermissionDialog:{type:"boolean",default:!0}},init:function(){this.locar=new nt(this.el.sceneEl.object3D,this.el.object3D),this.locar.on("gpsupdate",i=>{this.el.emit("gpsupdate",i)}),this.locar.on("gpserror",i=>{this.el.emit("gpserror",i)}),this._isMobile()&&(this.deviceOrientationControls=new dt(this.el.object3D,{smoothingFactor:this.data.smoothingFactor,enablePermissionDialog:this.data.enablePermissionDialog}),this.deviceOrientationControls.on("deviceorientationgranted",i=>{i.target.connect()}),this.deviceOrientationControls.on("deviceorientationerror",i=>{alert(`Device orientation error: code ${i.code} message ${i.message}`)}),this.deviceOrientationControls.init())},update:function(i){this.locar.setGpsOptions({gpsMinAccuracy:this.data.positionMinAccuracy,gpsMinDistance:this.data.gpsMinDistance}),(this.data.simulateLatitude!=(i==null?void 0:i.simulateLatitude)||this.data.simulateLongitude!=(i==null?void 0:i.simulateLongitude))&&(this.locar.stopGps(),this.locar.fakeGps(this.data.simulateLongitude,this.data.simulateLatitude),this.data.simulateLongitude=0,this.data.simulateLatitude=0),this.data.simulateAltitude>-Number.MAX_VALUE&&this.locar.setElevation(this.data.simulateAltitude+1.6)},play:function(){this.locar.startGps()},pause:function(){this.locar.stopGps()},lonLatToWorldCoords:function(i,n){return this.locar.lonLatToWorldCoords(i,n)},tick:function(){var i;(i=this.deviceOrientationControls)==null||i.update()},_isMobile:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||/Macintosh/i.test(navigator.userAgent)&&navigator.maxTouchPoints!=null&&navigator.maxTouchPoints>1}});AFRAME.registerComponent("locar-entity-place",{schema:{latitude:{type:"number",default:0},longitude:{type:"number",default:0}},init:function(){const i=this.el.sceneEl.querySelector("[locar-camera]");this.locarCamera=i.components["locar-camera"]},update:function(i){this.locarCamera||console.error("Cannot update locar-entity-place without a locar-camera component on the scene camera.");const n=this.locarCamera.lonLatToWorldCoords(this.data.longitude,this.data.latitude);this.el.object3D.position.set(n[0],this.el.object3D.position.y,n[1])}});
